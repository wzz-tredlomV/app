name: Android Build



on:

  push:

    branches: [ main ]

  pull_request:

    branches: [ main ]



jobs:

  build:

    runs-on: ubuntu-latest



    env:

      ANDROID_SDK_ROOT: /usr/local/android-sdk



    steps:

    - uses: actions/checkout@v4



    - name: Set up JDK 17

      uses: actions/setup-java@v3

      with:

        java-version: '17'

        distribution: 'temurin'



    - name: Cache Gradle

      uses: actions/cache@v4

      with:

        path: |

          ~/.gradle/caches

          ~/.gradle/wrapper

        key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}

        restore-keys: |

          ${{ runner.os }}-gradle-



    - name: Install Android SDK command-line tools and packages

      run: |

        sudo mkdir -p ${ANDROID_SDK_ROOT}

        sudo chown $USER ${ANDROID_SDK_ROOT}

        cd /tmp

        curl -sSL "https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip" -o cmdline-tools.zip

        unzip -q cmdline-tools.zip -d ${ANDROID_SDK_ROOT}



        # Handle different possible archive layouts:

        # Layout A (nested): ${ANDROID_SDK_ROOT}/cmdline-tools/cmdline-tools

        # Layout B (flat): ${ANDROID_SDK_ROOT}/cmdline-tools/{bin,lib,source.properties,...}

        if [ -d "${ANDROID_SDK_ROOT}/cmdline-tools/cmdline-tools" ]; then

          rm -rf "${ANDROID_SDK_ROOT}/cmdline-tools/latest"

          mv "${ANDROID_SDK_ROOT}/cmdline-tools/cmdline-tools" "${ANDROID_SDK_ROOT}/cmdline-tools/latest"

        elif [ -d "${ANDROID_SDK_ROOT}/cmdline-tools" ] && [ -f "${ANDROID_SDK_ROOT}/cmdline-tools/bin/sdkmanager" ]; then

          rm -rf "${ANDROID_SDK_ROOT}/cmdline-tools/latest"

          mkdir -p "${ANDROID_SDK_ROOT}/cmdline-tools/latest"

          # Move all current contents (bin, lib, NOTICE.txt, source.properties, ...) into latest

          # Use a loop to avoid moving the newly created 'latest' directory into itself

          for f in "${ANDROID_SDK_ROOT}/cmdline-tools"/*; do

            if [ "$(basename "$f")" != "latest" ]; then

              mv "$f" "${ANDROID_SDK_ROOT}/cmdline-tools/latest/" || true

            fi

          done

        else

          echo "Expected ${ANDROID_SDK_ROOT}/cmdline-tools/cmdline-tools or ${ANDROID_SDK_ROOT}/cmdline-tools with bin â€” listing contents:"

          ls -la "${ANDROID_SDK_ROOT}" || true

          ls -la "${ANDROID_SDK_ROOT}/cmdline-tools" || true

          exit 1

        fi



        rm -f cmdline-tools.zip



        # expose SDK to subsequent steps

        echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT}" >> $GITHUB_ENV

        echo "${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin" >> $GITHUB_PATH

        echo "${ANDROID_SDK_ROOT}/platform-tools" >> $GITHUB_PATH



        # accept licenses and install required packages for compileSdk 34

        yes | sdkmanager --sdk_root=${ANDROID_SDK_ROOT} --licenses

        sdkmanager --sdk_root=${ANDROID_SDK_ROOT} "platform-tools" "platforms;android-34" "build-tools;34.0.0"

      shell: bash



    - name: Build with Gradle

      run: |

        chmod +x ./gradlew

        ./gradlew assembleDebug --no-daemon --stacktrace --warning-mode all



    - name: Upload APK

      uses: actions/upload-artifact@v4

      with:

        name: app-debug

        path: app/build/outputs/apk/debug/*.apk



    - name: Upload Problems Report (if any)

      if: always()

      uses: actions/upload-artifact@v4

      with:

        name: problems-report

        path: app/build/reports/problems/problems-report.html
