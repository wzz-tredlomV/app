env:

  ANDROID_SDK_ROOT: /usr/local/android-sdk



steps:

- uses: actions/checkout@v4



- name: Set up JDK 17

  uses: actions/setup-java@v3

  with:

    java-version: '17'

    distribution: 'temurin'



- name: Cache Gradle

  uses: actions/cache@v4

  with:

    path: |

      ~/.gradle/caches

      ~/.gradle/wrapper

    key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}

    restore-keys: |

      ${{ runner.os }}-gradle-



- name: Install Android SDK command-line tools and packages

  run: |

    set -euo pipefail



    sudo mkdir -p "${ANDROID_SDK_ROOT}"

    sudo chown "$USER" "${ANDROID_SDK_ROOT}"



    cd /tmp

    curl -sSL "https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip" -o cmdline-tools.zip



    echo "Archive listing (first 50 lines):"

    unzip -l cmdline-tools.zip | sed -n '1,50p' || true



    unzip -q cmdline-tools.zip -d "${ANDROID_SDK_ROOT}"

    rm -f cmdline-tools.zip



    # Normalize layout: ensure ${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager exists

    if [ -d "${ANDROID_SDK_ROOT}/cmdline-tools/cmdline-tools" ]; then

      rm -rf "${ANDROID_SDK_ROOT}/cmdline-tools/latest" || true

      mv "${ANDROID_SDK_ROOT}/cmdline-tools/cmdline-tools" "${ANDROID_SDK_ROOT}/cmdline-tools/latest"

    elif [ -d "${ANDROID_SDK_ROOT}/cmdline-tools" ] && [ -f "${ANDROID_SDK_ROOT}/cmdline-tools/bin/sdkmanager" ]; then

      rm -rf "${ANDROID_SDK_ROOT}/cmdline-tools/latest" || true

      mkdir -p "${ANDROID_SDK_ROOT}/cmdline-tools/latest"

      for f in "${ANDROID_SDK_ROOT}/cmdline-tools"/*; do

        if [ "$(basename "$f")" != "latest" ]; then

          mv "$f" "${ANDROID_SDK_ROOT}/cmdline-tools/latest/" || true

        fi

      done

    fi



    echo "Listing ${ANDROID_SDK_ROOT}:"

    ls -la "${ANDROID_SDK_ROOT}" || true

    ls -la "${ANDROID_SDK_ROOT}/cmdline-tools" || true



    if [ ! -f "${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager" ]; then

      echo "sdkmanager not found at ${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager"

      exit 1

    fi



    # Make sdkmanager available in the current shell and for subsequent steps

    export PATH="${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin:${ANDROID_SDK_ROOT}/platform-tools:${PATH}"

    echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT}" >> $GITHUB_ENV

    echo "${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin" >> $GITHUB_PATH

    echo "${ANDROID_SDK_ROOT}/platform-tools" >> $GITHUB_PATH



    # Accept licenses and install packages (call sdkmanager by absolute path to avoid timing issues)

    yes | "${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager" --sdk_root="${ANDROID_SDK_ROOT}" --licenses

    "${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager" --sdk_root="${ANDROID_SDK_ROOT}" "platform-tools" "platforms;android-34" "build-tools;34.0.0"

  shell: bash



- name: Build with Gradle

  run: |

    chmod +x ./gradlew

    ./gradlew assembleDebug --no-daemon --stacktrace --warning-mode all



- name: Upload APK

  uses: actions/upload-artifact@v4

  with:

    name: app-debug

    path: app/build/outputs/apk/debug/*.apk



- name: Upload Problems Report (if any)

  if: always()

  uses: actions/upload-artifact@v4

  with:

    name: problems-report

    path: app/build/reports/problems/problems-report.html
