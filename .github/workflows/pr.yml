name: Pull Request Checks

on:
  pull_request:
    branches: [ main, master ]

jobs:
  code-review:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Check commit messages
      run: |
        git log --oneline ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | while read commit; do
          if ! echo "$commit" | grep -E "^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\([a-z]+\))?: .{1,}$"; then
            echo "❌ Invalid commit message: $commit"
            echo "Commit messages should follow: <type>(<scope>): <subject>"
            echo "Types: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert"
            exit 1
          fi
        done

    - name: Check for TODOs
      run: |
        if grep -r "TODO:" --include="*.kt" --include="*.java" --include="*.xml" . ; then
          echo "❌ Found TODO comments in code"
          exit 1
        fi

  build-check:
    needs: code-review
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Build project
      run: ./gradlew assembleDebug

  test-check:
    needs: code-review
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Run tests
      run: ./gradlew test

  lint-check:
    needs: code-review
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Run lint
      run: ./gradlew lint
