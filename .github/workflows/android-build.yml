name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: 自动创建gradlew文件（仅当不存在时）
      run: |
        # 只检查gradlew文件是否存在，如果不存在就创建
        if [ ! -f "./gradlew" ]; then
          echo "gradlew文件不存在，正在创建..."
          
          # 下载标准gradlew脚本
          curl -s -o gradlew https://raw.githubusercontent.com/gradle/gradle/master/gradlew
          chmod +x gradlew
          
          echo "gradlew文件创建完成"
        else
          echo "gradlew文件已存在，跳过创建"
          chmod +x ./gradlew
        fi
        
        # 确保gradle/wrapper目录存在
        mkdir -p gradle/wrapper
        
        # 如果gradle-wrapper.jar不存在，则下载
        if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ] && [ -f "gradle/wrapper/gradle-wrapper.properties" ]; then
          echo "gradle-wrapper.jar不存在，正在下载..."
          
          # 从gradle-wrapper.properties中读取gradle版本
          if grep -q "distributionUrl" gradle/wrapper/gradle-wrapper.properties; then
            GRADLE_VERSION=$(grep "distributionUrl" gradle/wrapper/gradle-wrapper.properties | \
              sed -n 's/.*gradle-\([0-9.]*\)-.*/\1/p')
            echo "使用Gradle版本: $GRADLE_VERSION"
            
            # 下载对应版本的gradle-wrapper.jar
            curl -s -o gradle/wrapper/gradle-wrapper.jar \
              "https://github.com/gradle/gradle/raw/v$GRADLE_VERSION/gradle/wrapper/gradle-wrapper.jar" || \
            echo "下载指定版本失败，尝试最新版本..."
          fi
          
          # 如果还是失败，下载最新版本
          if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            curl -s -o gradle/wrapper/gradle-wrapper.jar \
              https://github.com/gradle/gradle/raw/master/gradle/wrapper/gradle-wrapper.jar
          fi
          
          if [ -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            echo "gradle-wrapper.jar下载完成"
          fi
        fi
      
    - name: 使用gradlew构建APK
      run: |
        echo "使用gradlew构建APK..."
        ./gradlew assembleDebug
        
    - name: 上传APK产物
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: "**/build/outputs/apk/debug/*.apk"
        retention-days: 7
